<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=IBM Plex Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.patrickwu.uk","root":"/","scheme":"Muse","version":"7.7.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="blog">
<meta property="og:url" content="http://blog.patrickwu.uk/">
<meta property="og:site_name" content="blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="patrick wu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.patrickwu.uk/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>blog</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-161160600-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">illustrative abstractions</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>home</a>

  </li>
        <li class="menu-item menu-item-archive">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>archive</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>tags</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hZ2V0cm9u"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/22/03/2020/Async-Await-for-Swift/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/22/03/2020/Async-Await-for-Swift/" class="post-title-link" itemprop="url">Async/Await for Swift</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>
              

              <time title="created: 22-03-2020 04:44:48 / modified: 04:50:35" itemprop="dateCreated datePublished" datetime="2020-03-22T04:44:48+00:00">22-03-2020</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Authors: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhdHRuZXI=" title="https://github.com/lattner">Chris Lattner<i class="fa fa-external-link"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pja2FydGVy" title="https://github.com/jckarter">Joe Groff<i class="fa fa-external-link"></i></span></li>
</ul>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Modern Cocoa development involves a lot of asynchronous programming using closures and completion handlers, but these APIs are hard to use.  This gets particularly problematic when many asynchronous operations are used, error handling is required, or control flow between asynchronous calls gets complicated.  This proposal describes a language extension to make this a lot more natural and less error prone.</p>
<p>This paper introduces a first class <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29yb3V0aW5l" title="https://en.wikipedia.org/wiki/Coroutine">Coroutine model<i class="fa fa-external-link"></i></span> to Swift. Functions can opt into to being <em>async</em>, allowing the programmer to compose complex logic involving asynchronous operations, leaving the compiler in charge of producing the necessary closures and state machines to implement that logic.</p>
<p>It is important to understand that this is proposing compiler support that is completely concurrency runtime-agnostic.  This proposal does not include a new runtime model (like “actors”) - it works just as well with GCD as with pthreads or another API. Furthermore, unlike designs in other languages, it is independent of specific coordination mechanisms, such as futures or channels, allowing these to be built as library feature. The only runtime support required is compiler support logic for transforming and manipulating the implicitly generated closures.</p>
<p>This draws some inspiration from an earlier proposal written by <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29sZWdhbnph" title="https://github.com/oleganza">Oleg Andreev<i class="fa fa-external-link"></i></span>, available <span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vb2xlZ2FuemEvNzM0MmVkODI5YmRkZDg2Zjc0MGE=" title="https://gist.github.com/oleganza/7342ed829bddd86f740a">here<i class="fa fa-external-link"></i></span>.  It has been significantly rewritten by <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhdHRuZXI=" title="https://github.com/lattner">Chris Lattner<i class="fa fa-external-link"></i></span> and <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pja2FydGVy" title="https://github.com/jckarter">Joe Groff<i class="fa fa-external-link"></i></span>.</p>
<h2 id="Motivation-Completion-handlers-are-suboptimal"><a href="#Motivation-Completion-handlers-are-suboptimal" class="headerlink" title="Motivation: Completion handlers are suboptimal"></a>Motivation: Completion handlers are suboptimal</h2><p>To provide motivation for why it is important to do something here, lets look at some of the problems that Cocoa (and server/cloud) programmers frequently face.</p>
<h4 id="Problem-1-Pyramid-of-doom"><a href="#Problem-1-Pyramid-of-doom" class="headerlink" title="Problem 1: Pyramid of doom"></a>Problem 1: Pyramid of doom</h4><p>Sequence of simple operations is unnaturally composed in the nested blocks.  Here is a<br>made up example showing this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData1</span><span class="params">(completionBlock: <span class="params">(result: Image)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    loadWebResource(<span class="string">"dataprofile.txt"</span>) &#123; dataResource <span class="keyword">in</span></span><br><span class="line">        loadWebResource(<span class="string">"imagedata.dat"</span>) &#123; imageResource <span class="keyword">in</span></span><br><span class="line">            decodeImage(dataResource, imageResource) &#123; imageTmp <span class="keyword">in</span></span><br><span class="line">                dewarpAndCleanupImage(imageTmp) &#123; imageResult <span class="keyword">in</span></span><br><span class="line">                    completionBlock(imageResult)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">processImageData1 &#123; image <span class="keyword">in</span></span><br><span class="line">    display(image)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This “pyramid of doom” makes it difficult to keep track of code that is running, and the stack of closures leads to many second order effects.</p>
<h4 id="Problem-2-Error-handling"><a href="#Problem-2-Error-handling" class="headerlink" title="Problem 2: Error handling"></a>Problem 2: Error handling</h4><p>Handling errors becomes difficult and very verbose. Swift 2 introduced an error handling model for synchronous code, but callback-based interfaces do not derive any benefit from it:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData2</span><span class="params">(completionBlock: <span class="params">(result: Image?, error: Error?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    loadWebResource(<span class="string">"dataprofile.txt"</span>) &#123; dataResource, error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> dataResource = dataResource <span class="keyword">else</span> &#123;</span><br><span class="line">            completionBlock(<span class="literal">nil</span>, error)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        loadWebResource(<span class="string">"imagedata.dat"</span>) &#123; imageResource, error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> imageResource = imageResource <span class="keyword">else</span> &#123;</span><br><span class="line">                completionBlock(<span class="literal">nil</span>, error)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            decodeImage(dataResource, imageResource) &#123; imageTmp, error <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> imageTmp = imageTmp <span class="keyword">else</span> &#123;</span><br><span class="line">                    completionBlock(<span class="literal">nil</span>, error)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                dewarpAndCleanupImage(imageTmp) &#123; imageResult <span class="keyword">in</span></span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> imageResult = imageResult <span class="keyword">else</span> &#123;</span><br><span class="line">                        completionBlock(<span class="literal">nil</span>, error)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    completionBlock(imageResult)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">processImageData2 &#123; image, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> image = image <span class="keyword">else</span> &#123;</span><br><span class="line">        error(<span class="string">"No image today"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    display(image)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Problem-3-Conditional-execution-is-hard-and-error-prone"><a href="#Problem-3-Conditional-execution-is-hard-and-error-prone" class="headerlink" title="Problem 3: Conditional execution is hard and error-prone"></a>Problem 3: Conditional execution is hard and error-prone</h4><p>Conditionally executing an asynchronous function is a huge pain.  Perhaps the best approach is to write half of the code in a helper “continuation” closure that is conditionally executed, like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData3</span><span class="params">(recipient: Person, completionBlock: <span class="params">(result: Image)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> continuation: (contents: image) -&gt; <span class="type">Void</span> = &#123;</span><br><span class="line">      <span class="comment">// ... continue and call completionBlock eventually</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> recipient.hasProfilePicture &#123;</span><br><span class="line">        continuation(recipient.profilePicture)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decodeImage &#123; image <span class="keyword">in</span></span><br><span class="line">            continuation(image)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Problem-4-Many-mistakes-are-easy-to-make"><a href="#Problem-4-Many-mistakes-are-easy-to-make" class="headerlink" title="Problem 4: Many mistakes are easy to make"></a>Problem 4: Many mistakes are easy to make</h4><p>It’s easy to bail out by simply returning without calling the appropriate block. When forgotten, the issue is very hard to debug:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData4</span><span class="params">(completionBlock: <span class="params">(result: Image?, error: Error?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    loadWebResource(<span class="string">"dataprofile.txt"</span>) &#123; dataResource, error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> dataResource = dataResource <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="comment">// &lt;- forgot to call the block</span></span><br><span class="line">        &#125;</span><br><span class="line">        loadWebResource(<span class="string">"imagedata.dat"</span>) &#123; imageResource, error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> imageResource = imageResource <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="comment">// &lt;- forgot to call the block</span></span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When you do not forget to call the block, you can still forget to return after that.<br>Thankfully <code>guard</code> syntax protects against that to some degree, but it’s not always relevant.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData5</span><span class="params">(recipient:Person, completionBlock: <span class="params">(result: Image?, error: Error?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> recipient.hasProfilePicture &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> image = recipient.profilePicture &#123;</span><br><span class="line">            completionBlock(image) <span class="comment">// &lt;- forgot to return after calling the block</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Problem-5-Because-completion-handlers-are-awkward-too-many-APIs-are-defined-synchronously"><a href="#Problem-5-Because-completion-handlers-are-awkward-too-many-APIs-are-defined-synchronously" class="headerlink" title="Problem 5: Because completion handlers are awkward, too many APIs are defined synchronously"></a>Problem 5: Because completion handlers are awkward, too many APIs are defined synchronously</h4><p>This is hard to quantify, but the authors believe that the awkwardness of defining and using asynchronous APIs (using completion handlers) has led to many APIs being defined with apparently synchronous behavior, even when they can block.  This can lead to problematic performance and responsiveness problems in UI applications - e.g. spinning cursor.  It can also lead to the definition of APIs that cannot be used when asynchrony is critical to achieve scale, e.g. on the server.</p>
<h4 id="Problem-6-Other-“resumable”-computations-are-awkward-to-define"><a href="#Problem-6-Other-“resumable”-computations-are-awkward-to-define" class="headerlink" title="Problem 6: Other “resumable” computations are awkward to define"></a>Problem 6: Other “resumable” computations are awkward to define</h4><p>The problems described above are on specific case of a general class of problems involving “resumable” computations.   For example, if you want to write code that produces a list of squares of numbers, you might write something like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="number">10</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(i*i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>However, if you want to write this as a Swift sequence, you have to define this as something that incrementally produces values.  There are multiple ways to do this (e.g. using <code>AnyIterator</code>, or the <code>sequence(state:,next:)</code> functions), but none of them approach the clarity and obviousness of the imperative form.</p>
<p>In contrast, languages that have generators allow you to write something more close to this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSequence</span><span class="params">()</span></span> -&gt; <span class="type">AnySequence</span>&lt;<span class="type">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> seq = sequence &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="number">10</span> &#123;</span><br><span class="line">            yield(i*i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">AnySequence</span>(seq)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is the responsibility of the compiler to transform the function into a form that incrementally produces values, by producing a state machine.</p>
<h2 id="Proposed-Solution-Coroutines"><a href="#Proposed-Solution-Coroutines" class="headerlink" title="Proposed Solution: Coroutines"></a>Proposed Solution: Coroutines</h2><p>These problem have been faced in many systems and many languages, and the abstraction of <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29yb3V0aW5l" title="https://en.wikipedia.org/wiki/Coroutine">coroutines<i class="fa fa-external-link"></i></span> is a standard way to address them.  Without delving too much into theory, coroutines are an extension of basic functions that allow a function to return a value <em>or be suspended</em>.  They can be used to implement generators, asynchronous models, and other capabilities - there is a large body of work on the theory, implementation, and optimization of them.</p>
<p>This proposal adds general coroutine support to Swift, biasing the nomenclature and terminology towards the most common use-case: defining and using asynchronous APIs, eliminating many of the problems working with completion handlers.  The choice of terminology (<code>async</code> vs <code>yields</code>) is a bikeshed topic which needs to be addressed, but isn’t pertinent to the core semantics of the model.  See <a href="#alternate-syntax-options">Alternate Syntax Options</a> at the end for an exploration of syntactic options in this space.</p>
<p>It is important to understand up-front, that the proposed coroutine model does not interface<br>with any particular concurrency primitives on the system: you can think of it as syntactic<br>sugar for completion handlers.  This means that the introduction of coroutines would not<br>change the queues that completion handlers are called on, as happens in some other systems.</p>
<h3 id="Async-semantics"><a href="#Async-semantics" class="headerlink" title="Async semantics"></a>Async semantics</h3><p>Today, function types can be normal or <code>throw</code>ing.  This proposal extends them to also be allowed to be <code>async</code>.  These are all valid function types:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">Int</span>) -&gt; <span class="type">Int</span>               <span class="comment">// #1: Normal function</span></span><br><span class="line">(<span class="type">Int</span>) <span class="keyword">throws</span> -&gt; <span class="type">Int</span>        <span class="comment">// #2: Throwing function</span></span><br><span class="line">(<span class="type">Int</span>) async -&gt; <span class="type">Int</span>         <span class="comment">// #3: Asynchronous function</span></span><br><span class="line">(<span class="type">Int</span>) async <span class="keyword">throws</span> -&gt; <span class="type">Int</span>  <span class="comment">// #4: Asynchronous function, can also throw.</span></span><br></pre></td></tr></table></figure>
<p>Just as a normal function (#1) will implicitly convert to a throwing function (#2), an async function (#3) implicitly converts to a throwing async function (#4).</p>
<p>On the function declaration side of the things, you can declare a function as being asynchronous just as you declare it to be throwing, but use the <code>async</code> keyword:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async -&gt; <span class="type">Image</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Semantically similar to this:</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">(completionHandler: <span class="params">(result: Image)</span></span></span> -&gt; <span class="type">Void</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>Calls to <code>async</code> functions can implicitly suspend the current coroutine.  To make this apparent to maintainers of code, you are required to “mark” expressions that call <code>async</code> functions with the new <code>await</code> keyword (exactly analogously to how <code>try</code> is used to mark subexpressions that contain throwing calls).  Putting these pieces together, the first example (from the pyramid of doom explanation, above) can be rewritten in a more natural way:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadWebResource</span><span class="params">(<span class="number">_</span> path: String)</span></span> async -&gt; <span class="type">Resource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decodeImage</span><span class="params">(<span class="number">_</span> r1: Resource, <span class="number">_</span> r2: Resource)</span></span> async -&gt; <span class="type">Image</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dewarpAndCleanupImage</span><span class="params">(<span class="number">_</span> i : Image)</span></span> async -&gt; <span class="type">Image</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData1</span><span class="params">()</span></span> async -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dataResource  = await loadWebResource(<span class="string">"dataprofile.txt"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageResource = await loadWebResource(<span class="string">"imagedata.dat"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageTmp      = await decodeImage(dataResource, imageResource)</span><br><span class="line">  <span class="keyword">let</span> imageResult   =  await dewarpAndCleanupImage(imageTmp)</span><br><span class="line">  <span class="keyword">return</span> imageResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Under the hood, the compiler rewrites this code using nested closures like in example <code>processImageData1</code> above. Note that every operation starts only after the previous one has completed, but each call site to an <code>async</code> function could suspend execution of the current function.</p>
<p>Finally, you are only allowed to invoke an <code>async</code> function from within another <code>async</code> function or closure.  This follows the model of Swift 2 error handling, where you cannot call a throwing function unless you’re in a throwing function or inside of a <code>do/catch</code> block.</p>
<h4 id="Entering-and-leaving-async-code"><a href="#Entering-and-leaving-async-code" class="headerlink" title="Entering and leaving async code"></a>Entering and leaving async code</h4><p>In the common case, async code ought to be invoking other async code that has been dispatched by the framework the app is built on top of, but at some point, an async process needs to spawn from a controlling synchronous context, and the async process needs to be able to suspend itself and allow its <strong>continuation</strong> to be scheduled by the controlling context. We need a couple of primitives to<br>enable entering and suspending an async context:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NB: Names subject to bikeshedding. These are low-level primitives that most</span></span><br><span class="line"><span class="comment">// users should not need to interact with directly, so namespacing them</span></span><br><span class="line"><span class="comment">// and/or giving them verbose names unlikely to collide or pollute code</span></span><br><span class="line"><span class="comment">// completion (and possibly not even exposing them outside the stdlib to begin</span></span><br><span class="line"><span class="comment">// with) would be a good idea.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Begins an asynchronous coroutine, transferring control to `body` until it</span></span><br><span class="line"><span class="comment">/// either suspends itself for the first time with `suspendAsync` or completes,</span></span><br><span class="line"><span class="comment">/// at which point `beginAsync` returns. If the async process completes by</span></span><br><span class="line"><span class="comment">/// throwing an error before suspending itself, `beginAsync` rethrows the error.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">beginAsync</span><span class="params">(<span class="number">_</span> body: <span class="params">()</span></span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Void</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">Void</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Suspends the current asynchronous task and invokes `body` with the task's</span></span><br><span class="line"><span class="comment">/// continuation closure. Invoking `continuation` will resume the coroutine</span></span><br><span class="line"><span class="comment">/// by having `suspendAsync` return the value passed into the continuation.</span></span><br><span class="line"><span class="comment">/// It is a fatal error for `continuation` to be invoked more than once.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">suspendAsync</span>&lt;T&gt;<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">_</span> body: <span class="params">(<span class="number">_</span> continuation: @escaping <span class="params">(T)</span></span></span></span> -&gt; ()) -&gt; ()</span><br><span class="line">) async -&gt; <span class="type">T</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Suspends the current asynchronous task and invokes `body` with the task's</span></span><br><span class="line"><span class="comment">/// continuation and failure closures. Invoking `continuation` will resume the</span></span><br><span class="line"><span class="comment">/// coroutine by having `suspendAsync` return the value passed into the</span></span><br><span class="line"><span class="comment">/// continuation. Invoking `error` will resume the coroutine by having</span></span><br><span class="line"><span class="comment">/// `suspendAsync` throw the error passed into it. Only one of</span></span><br><span class="line"><span class="comment">/// `continuation` and `error` may be called; it is a fatal error if both are</span></span><br><span class="line"><span class="comment">/// called, or if either is called more than once.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">suspendAsync</span>&lt;T&gt;<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">_</span> body: <span class="params">(<span class="number">_</span> continuation: @escaping <span class="params">(T)</span></span></span></span> -&gt; (),</span><br><span class="line">           <span class="number">_</span> error: @escaping (<span class="type">Error</span>) -&gt; ()) -&gt; ()</span><br><span class="line">) async <span class="keyword">throws</span> -&gt; <span class="type">T</span></span><br></pre></td></tr></table></figure>
<p>These are similar to the “shift” and “reset” primitives of <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGVsaW1pdGVkX2NvbnRpbnVhdGlvbg==" title="https://en.wikipedia.org/wiki/Delimited_continuation">delimited continuations<i class="fa fa-external-link"></i></span>.  These enable a non-async function to call an <code>async</code> function.  For example, consider this<br><code>@IBAction</code> written with completion handlers:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">buttonDidClick</span><span class="params">(sender:AnyObject)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  processImage(completionHandler: &#123;(image) <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    imageView.image = image</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is an essential pattern, but is itself sort of odd: an <code>async</code> operation is being fired off immediately (#1), then runs the subsequent code (#3), and the completion handler (#2) runs at some time later — on some queue (often the main one).  This pattern frequently leads to mutation of global state (as in this example) or to making assumptions about which queue the completion handler is run on.  Despite these problems, it is essential that the model encompasses this pattern, because it is a practical necessity in Cocoa development.  With this proposal, it would look like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">buttonDidClick</span><span class="params">(sender:AnyObject)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  beginAsync &#123;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">let</span> image = await processImage()</span><br><span class="line">    imageView.image = image</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>These primitives enable callback-based APIs to be wrapped up as async coroutine APIs:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Legacy callback-based API</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStuff</span><span class="params">(completion: <span class="params">(Stuff)</span></span></span> -&gt; <span class="type">Void</span>) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swift wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStuff</span><span class="params">()</span></span> async -&gt; <span class="type">Stuff</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> await suspendAsync &#123; continuation <span class="keyword">in</span></span><br><span class="line">    getStuff(completion: continuation)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Functionality of concurrency libraries such as libdispatch and pthreads can<br>also be presented in coroutine-friendly ways:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DispatchQueue</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Move execution of the current coroutine synchronously onto this queue.</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">syncCoroutine</span><span class="params">()</span></span> async -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">    await suspendAsync &#123; continuation <span class="keyword">in</span></span><br><span class="line">      sync &#123; continuation &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Enqueue execution of the remainder of the current coroutine</span></span><br><span class="line">  <span class="comment">/// asynchronously onto this queue.</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">asyncCoroutine</span><span class="params">()</span></span> async -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">    await suspendAsync &#123; continuation <span class="keyword">in</span></span><br><span class="line">      async &#123; continuation &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queueHopping</span><span class="params">()</span></span> async -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">  doSomeStuff()</span><br><span class="line">  await <span class="type">DispatchQueue</span>.main.syncCoroutine()</span><br><span class="line">  doSomeStuffOnMainThread()</span><br><span class="line">  await backgroundQueue.asyncCoroutine()</span><br><span class="line">  doSomeStuffInBackground()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Generalized abstractions for coordinating coroutines can also be built. The simplest of these is a <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRnV0dXJlc19hbmRfcHJvbWlzZXM=" title="https://en.wikipedia.org/wiki/Futures_and_promises">future<i class="fa fa-external-link"></i></span>, a value that represents a future value which may not be resolved yet.  The exact design for a Future type is out of scope for this proposal (it should be its own follow-on proposal), but an example proof of concept could look like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">enum</span> <span class="title">Result</span> </span>&#123; <span class="keyword">case</span> error(<span class="type">Error</span>), value(<span class="type">T</span>) &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> result: <span class="type">Result?</span> = <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> awaiters: [(<span class="type">Result</span>) -&gt; <span class="type">Void</span>] = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fulfill the future, and resume any coroutines waiting for the value.</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">fulfill</span><span class="params">(<span class="number">_</span> value: T)</span></span> &#123;</span><br><span class="line">    <span class="built_in">precondition</span>(<span class="keyword">self</span>.result == <span class="literal">nil</span>, <span class="string">"can only be fulfilled once"</span>)</span><br><span class="line">    <span class="keyword">let</span> result = .value(value)</span><br><span class="line">    <span class="keyword">self</span>.result = result</span><br><span class="line">    <span class="keyword">for</span> awaiter <span class="keyword">in</span> awaiters &#123;</span><br><span class="line">      <span class="comment">// A robust future implementation should probably resume awaiters</span></span><br><span class="line">      <span class="comment">// concurrently into user-controllable contexts. For simplicity this</span></span><br><span class="line">      <span class="comment">// proof-of-concept simply resumes them all serially in the current</span></span><br><span class="line">      <span class="comment">// context.</span></span><br><span class="line">      awaiter(result)</span><br><span class="line">    &#125;</span><br><span class="line">    awaiters = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Mark the future as having failed to produce a result.</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">fail</span><span class="params">(<span class="number">_</span> error: Error)</span></span> &#123;</span><br><span class="line">    <span class="built_in">precondition</span>(<span class="keyword">self</span>.result == <span class="literal">nil</span>, <span class="string">"can only be fulfilled once"</span>)</span><br><span class="line">    <span class="keyword">let</span> result = .error(error)</span><br><span class="line">    <span class="keyword">self</span>.result = result</span><br><span class="line">    <span class="keyword">for</span> awaiter <span class="keyword">in</span> awaiters &#123;</span><br><span class="line">      awaiter(result)</span><br><span class="line">    &#125;</span><br><span class="line">    awaiters = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> result &#123;</span><br><span class="line">    <span class="comment">// Throw/return the result immediately if available.</span></span><br><span class="line">    <span class="keyword">case</span> .error(<span class="keyword">let</span> e)?:</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    <span class="keyword">case</span> .value(<span class="keyword">let</span> v)?:</span><br><span class="line">      <span class="keyword">return</span> v</span><br><span class="line">    <span class="comment">// Wait for the future if no result has been fulfilled.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">      <span class="keyword">return</span> await suspendAsync &#123; continuation, error <span class="keyword">in</span></span><br><span class="line">        awaiters.append(&#123;</span><br><span class="line">          <span class="keyword">switch</span> $<span class="number">0</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> .error(<span class="keyword">let</span> e): error(e)</span><br><span class="line">          <span class="keyword">case</span> .value(<span class="keyword">let</span> v): continuation(v)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an unfulfilled future.</span></span><br><span class="line">  <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Begin a coroutine by invoking `body`, and create a future representing</span></span><br><span class="line">  <span class="comment">// the eventual result of `body`'s completion.</span></span><br><span class="line">  <span class="keyword">convenience</span> <span class="keyword">init</span>(<span class="number">_</span> body: () async -&gt; <span class="type">T</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">init</span>()</span><br><span class="line">    beginAsync &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.fulfill(await body())</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.fail(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To reiterate, it is well known that this specific implementation has performance and API weaknesses, the point is merely to sketch how an abstraction like this could be built on top of <code>async</code>/<code>await</code>.</p>
<p>Futures allow parallel execution, by moving <code>await</code> from the call to the result when it is needed, and wrapping the parallel calls in individual <code>Future</code> objects:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData1a</span><span class="params">()</span></span> async -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dataResource  = <span class="type">Future</span> &#123; await loadWebResource(<span class="string">"dataprofile.txt"</span>) &#125;</span><br><span class="line">  <span class="keyword">let</span> imageResource = <span class="type">Future</span> &#123; await loadWebResource(<span class="string">"imagedata.dat"</span>) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... other stuff can go here to cover load latency...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> imageTmp    = await decodeImage(dataResource.<span class="keyword">get</span>(), imageResource.<span class="keyword">get</span>())</span><br><span class="line">  <span class="keyword">let</span> imageResult = await dewarpAndCleanupImage(imageTmp)</span><br><span class="line">  <span class="keyword">return</span> imageResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the above example, the first two operations will start one after another, and the unevaluated computations are wrapped into a <code>Future</code> value.  This allows all of them to happen concurrently (in a way that need not be defined by the language or by the <code>Future</code> implementation), and the function will wait for completion of them before decoding the image.  Note that <code>await</code> does not block flow of execution: if the value is not yet ready, execution of the current <code>async</code> function is suspended, and control flow passes to something higher up in the stack.</p>
<p>Other coordination abstractions such as <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29tbXVuaWNhdGluZ19zZXF1ZW50aWFsX3Byb2Nlc3Nlcw==" title="https://en.wikipedia.org/wiki/Communicating_sequential_processes">Communicating Sequential Process channels<i class="fa fa-external-link"></i></span> or <span class="exturl" data-url="aHR0cHM6Ly93aW5nb2xvZy5vcmcvYXJjaGl2ZXMvMjAxNy8wNi8yOS9hLW5ldy1jb25jdXJyZW50LW1s" title="https://wingolog.org/archives/2017/06/29/a-new-concurrent-ml">Concurrent ML events<i class="fa fa-external-link"></i></span> can also be developed as libraries for coordinating coroutines; their implementation is left as an exercise for the reader.</p>
<h2 id="Conversion-of-imported-Objective-C-APIs"><a href="#Conversion-of-imported-Objective-C-APIs" class="headerlink" title="Conversion of imported Objective-C APIs"></a>Conversion of imported Objective-C APIs</h2><p>Full details are beyond the scope of this proposal, but it is important to enhance the importer to project Objective-C completion-handler based APIs into <code>async</code> forms.  This is a transformation comparable to how <code>NSError**</code> functions are imported as <code>throws</code> functions.  Having the importer do this means that many Cocoa APIs will be modernized en masse.</p>
<p>There are multiple possible designs for this with different tradeoffs.  The maximally source compatible way to do this is to import completion handler-based APIs in two forms: both the completion handler and the <code>async</code> form.  For example, given:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before</span></span><br><span class="line">- (<span class="keyword">void</span>) processImageData:(<span class="keyword">void</span>(^)())completionHandler;</span><br><span class="line">- (<span class="keyword">void</span>) processImageData:(<span class="keyword">void</span>(^)(Image* __<span class="keyword">nonnull</span> image))completionHandler;</span><br><span class="line">- (<span class="keyword">void</span>) processImageData:(<span class="keyword">void</span>(^)(Image* __<span class="keyword">nullable</span> image1, <span class="built_in">NSError</span>* __<span class="keyword">nullable</span> error))completionHandler;</span><br><span class="line">- (<span class="keyword">void</span>) processImageData:(<span class="keyword">void</span>(^)(Image* __<span class="keyword">nullable</span> half1, Image* __<span class="keyword">nullable</span> half2, <span class="built_in">NSError</span>* __<span class="keyword">nullable</span> error))completionHandler;</span><br><span class="line">- (<span class="keyword">void</span>) processImageData:(<span class="keyword">void</span>(^)(<span class="built_in">NSError</span>* __<span class="keyword">nullable</span> error))completionHandler;</span><br></pre></td></tr></table></figure>
<p>The declarations above are imported both in their normal completion handler form, but also in their nicer <code>async</code> forms:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async -&gt; <span class="type">Image</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Image</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; (half1: <span class="type">Image</span>, half2: <span class="type">Image</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async <span class="keyword">throws</span></span><br></pre></td></tr></table></figure>
<p>There are many details that should be defined as part of this importing process - for example:</p>
<ul>
<li>What are the exact rules for the transformation?</li>
<li>Are multiple result functions common enough to handle automatically?</li>
<li>Would it be better to just import completion handler functions only as <code>async</code> in Swift 5 mode, forcing migration?</li>
<li>What should happen with the non-Void-returning completion handler functions (e.g. in <code>URLSession</code>)?</li>
<li>Should <code>Void</code>-returning methods that are commonly used to trigger asynchronous operations in response to events, such as <code>IBAction</code> methods, be imported as <code>async -&gt; Void</code>?</li>
</ul>
<p>Without substantial ObjC importer work, making a clean break and forcing migration in Swift 5 mode would be the most practical way to preserve overridability, but would create a lot of churn in 4-to-5 migration. Alternatively, it may be acceptable to present the <code>async</code> versions as <code>final</code> wrappers over the underlying callback-based interfaces; this would subclassers to work with the callback-based interface, but there are generally fewer subclassers than callers.</p>
<h2 id="Interaction-with-existing-features"><a href="#Interaction-with-existing-features" class="headerlink" title="Interaction with existing features"></a>Interaction with existing features</h2><p>This proposal dovetails naturally with existing language features in Swift, here are a few examples:</p>
<h4 id="Error-handling"><a href="#Error-handling" class="headerlink" title="Error handling"></a>Error handling</h4><p>Error handling syntax introduced in Swift 2 composes naturally with this asynchronous model.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Could throw or be interrupted:</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Image</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Semantically similar to:</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">(completionHandler: <span class="params">(result: Image?, error: Error?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br></pre></td></tr></table></figure>
<p>Our example thus becomes (compare with the example <code>processImageData2</code>):</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadWebResource</span><span class="params">(<span class="number">_</span> path: String)</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Resource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decodeImage</span><span class="params">(<span class="number">_</span> r1: Resource, <span class="number">_</span> r2: Resource)</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Image</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dewarpAndCleanupImage</span><span class="params">(i: Image)</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Vegetable</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData2</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dataResource  = <span class="keyword">try</span> await loadWebResource(<span class="string">"dataprofile.txt"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageResource = <span class="keyword">try</span> await loadWebResource(<span class="string">"imagedata.dat"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageTmp      = <span class="keyword">try</span> await decodeImage(dataResource, imageResource)</span><br><span class="line">  <span class="keyword">let</span> imageResult   = <span class="keyword">try</span> await dewarpAndCleanupImage(imageTmp)</span><br><span class="line">  <span class="keyword">return</span> imageResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Coroutines address one of the major shortcomings of the Swift 2 error model,<br>that it did not interoperate well with callback-oriented asynchronous APIs and<br>required clumsy boilerplate to propagate errors across callback boundaries.</p>
<h4 id="Closure-type-inference"><a href="#Closure-type-inference" class="headerlink" title="Closure type inference"></a>Closure type inference</h4><p>Because the <code>await</code> keyword is used at all points where execution may be suspended, it is simple for the compiler to determine whether a closure is <code>async</code> or not: it is if the body includes an <code>await</code>.  This works exactly the same way that the presence of <code>try</code> in a closure causes it to be inferred as a throwing closure.  You can also explicitly mark a closure as <code>async</code> using the standard form of:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myClosure = &#123; () async -&gt; () <span class="keyword">in</span> ... &#125;</span><br></pre></td></tr></table></figure>
<h4 id="defer-and-abandonment"><a href="#defer-and-abandonment" class="headerlink" title="defer and abandonment"></a><code>defer</code> and abandonment</h4><p>Coroutines can be suspended, and while suspended, there is the potential for a coroutine’s execution to be <strong>abandoned</strong> if all references to its continuation<br>closure(s) are released without being executed:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Shut down the current coroutine and give its memory back to the</span></span><br><span class="line"><span class="comment">/// shareholders.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">abandon</span><span class="params">()</span></span> async -&gt; <span class="type">Never</span> &#123;</span><br><span class="line">  await suspendAsync &#123; <span class="number">_</span> = $<span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is to be expected that, upon abandonment, any references captured in wait by the continuation should be released, as with any closure. However, there may be other cleanup that must be guaranteed to occur. <code>defer</code> serves the general<br>role of “guaranteed cleanup” in synchronous code, and it would be a natural<br>extension to add the guarantee that <code>defer</code>-ed statements also execute as part<br>of cleaning up an abandoned coroutine:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">  startProgressBar()</span><br><span class="line">  <span class="keyword">defer</span> &#123;</span><br><span class="line">    <span class="comment">// This will be called when error is thrown, when all operations</span></span><br><span class="line">    <span class="comment">// complete and a result is returned, or when the coroutine is</span></span><br><span class="line">    <span class="comment">// abandoned. We don't want to leave the progress bar animating if</span></span><br><span class="line">    <span class="comment">// work has stopped.</span></span><br><span class="line">    stopProgressBar()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataResource  = <span class="keyword">try</span> await loadWebResource(<span class="string">"dataprofile.txt"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageResource = <span class="keyword">try</span> await loadWebResource(<span class="string">"imagedata.dat"</span>)</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> imageTmp    = <span class="keyword">try</span> await decodeImage(dataResource, imageResource)</span><br><span class="line">  &#125; <span class="keyword">catch</span> <span class="number">_</span> <span class="keyword">as</span> <span class="type">CorruptedImage</span> &#123;</span><br><span class="line">    <span class="comment">// Give up hope now.</span></span><br><span class="line">    await abandon()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">try</span> await dewarpAndCleanupImage(imageTmp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This fills in another gap in the expressivity of callback-based APIs, where it is difficult to express cleanup code that must execute at some point regardless of whether the callback closure is really called. However, abandonment should not be taken as a fully-baked “cancellation” feature; if cancellation is important, it should continue to be implemented by the programmer where needed, and there are many standard patterns that can be applied. Particularly when coupled with error handling, common cancellation patterns become very elegant:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@IBAction func processImageData(sender: AnyObject) &#123;</span><br><span class="line">  beginAsync &#123;</span><br><span class="line">    do &#123;</span><br><span class="line">      let dataResource  &#x3D; try await imageProcessor.loadWebResource(&quot;dataprofile.txt&quot;)</span><br><span class="line">      let imageResource &#x3D; try await imageProcessor.loadWebResource(&quot;imagedata.dat&quot;)</span><br><span class="line">      let imageTmp      &#x3D; try await imageProcessor.decodeImage(dataResource, imageResource)</span><br><span class="line">      let imageResult   &#x3D; try await imageProcessor.dewarpAndCleanupImage(imageTmp)</span><br><span class="line">      display(imageResult)</span><br><span class="line">    &#125; catch CocoaError.userCancelled &#123;</span><br><span class="line">      &#x2F;&#x2F; Ignore, user quit the kitchen.</span><br><span class="line">    &#125; catch &#123;</span><br><span class="line">      &#x2F;&#x2F; Some really interesting error happened</span><br><span class="line">      presentError(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@IBAction func stopImageProcessing(sender: AnyObject) &#123;</span><br><span class="line">  imageProcessor.cancel()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Internally, <code>imageProcessor</code> may use <code>NSOperation</code> or a custom <code>cancelled</code> flag. The intent of this section is to give a single example of how to approach this, not to define a normative or all-encompassing approach that should be used in all cases.</p>
<h4 id="Completion-handlers-with-multiple-return-values"><a href="#Completion-handlers-with-multiple-return-values" class="headerlink" title="Completion handlers with multiple return values"></a>Completion handlers with multiple return values</h4><p>Completion handler APIs may have multiple result arguments (not counting an error argument). These are naturally represented by tuple results in <code>async</code> functions:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageHalves</span><span class="params">(completionHandler: <span class="params">(part1: Image?, part2: Image?, error: Error?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// After</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageHalves</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; (<span class="type">Image</span>, <span class="type">Image</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Source-Compatibility"><a href="#Source-Compatibility" class="headerlink" title="Source Compatibility"></a>Source Compatibility</h2><p>This is a generally additive feature, but it does take <code>async</code> and <code>await</code> as keywords, so it will break code that uses them as identifiers.  This is expected to have very minor impact: the most pervasive use of <code>async</code> as an identifier occurs in code that works with dispatch queues, but fortunately keywords are allowed as qualified member names, so code like this doesn’t need any change:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myQueue.async &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>That said, there could be obscure cases that break.  One example that occurs in the Swift testsuite is of the form:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DispatchQueue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">myThing</span><span class="params">()</span></span> &#123;</span><br><span class="line">    async &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This can be addressed by changing the code to use <code>self.async</code> or backticks.  The compiler should be able to detect a large number of these cases and produce a fixit.</p>
<h2 id="Effect-on-ABI-stability"><a href="#Effect-on-ABI-stability" class="headerlink" title="Effect on ABI stability"></a>Effect on ABI stability</h2><p>This proposal does not change the ABI of any existing language features, but does introduce a new concept that adds to the ABI surface area, including a new mangling and calling convention.</p>
<h2 id="Alternate-Syntax-Options"><a href="#Alternate-Syntax-Options" class="headerlink" title="Alternate Syntax Options"></a>Alternate Syntax Options</h2><p>Here are a couple of syntax level changes to the proposal that are worth discussing, these don’t fundamentally change the shape of the proposal.</p>
<h4 id="Spelling-of-async-keyword"><a href="#Spelling-of-async-keyword" class="headerlink" title="Spelling of async keyword"></a>Spelling of <code>async</code> keyword</h4><p>Instead of spelling the function type modifier as <code>async</code>, it could be spelled as <code>yields</code>, since the functionality really is about coroutines, not about asynchrony by itself.  The recommendation to use <code>async/await</code> biases towards making sure that the most common use case (asynchrony) uses industry standard terms.  The other coroutine use cases would be much less common, at least according to the unscientific opinion of the proposal authors.</p>
<p>To give an idea of what this could look like, here’s the example from above resyntaxed:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadWebResource</span><span class="params">(<span class="number">_</span> path: String)</span></span> yields -&gt; <span class="type">Resource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decodeImage</span><span class="params">(<span class="number">_</span> r1: Resource, <span class="number">_</span> r2: Resource)</span></span> yields -&gt; <span class="type">Image</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dewarpAndCleanupImage</span><span class="params">(<span class="number">_</span> i : Image)</span></span> yields -&gt; <span class="type">Image</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processImageData1</span><span class="params">()</span></span> yields -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dataResource  = yield loadWebResource(<span class="string">"dataprofile.txt"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageResource = yield loadWebResource(<span class="string">"imagedata.dat"</span>)</span><br><span class="line">  <span class="keyword">let</span> imageTmp      = yield decodeImage(dataResource, imageResource)</span><br><span class="line">  <span class="keyword">let</span> imageResult   = yield dewarpAndCleanupImage(imageTmp)</span><br><span class="line">  <span class="keyword">return</span> imageResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Make-async-be-a-subtype-of-throws-instead-of-orthogonal-to-it"><a href="#Make-async-be-a-subtype-of-throws-instead-of-orthogonal-to-it" class="headerlink" title="Make async be a subtype of throws instead of orthogonal to it"></a>Make <code>async</code> be a subtype of <code>throws</code> instead of orthogonal to it</h4><p>It would be a great simplification of the language model to make the <code>async</code> modifier on a function imply that the function is <code>throw</code>ing, instead of making them orthogonal modifiers.  From an intuitive perspective, this makes sense because many of the sorts of operations that are asynchronous (e.g. loading a resource, talking to the network, etc) can also fail.   There is also precedent from many other systems that use <code>async</code>/<code>await</code> for this; for example, .NET <code>Task</code>s and Javascript promises both combine error handling with async sequencing. One could argue that that’s because .NET and Javascript’s established runtimes both feature pervasive implicit exceptions; however, popular async frameworks for the Rust programming language, such as <span class="exturl" data-url="aHR0cHM6Ly90b2tpby5ycw==" title="https://tokio.rs">tokio.rs<i class="fa fa-external-link"></i></span>, have also chosen to incorporate error handling directly into their <code>Future</code> constructs, because doing so was found to be more practical and ergonomic than trying to compose theoretically-orthogonal <code>Future&lt;T&gt;</code> and <code>Result&lt;T&gt;</code> constructs.</p>
<p>If we made <code>async</code> a subtype of <code>throws</code>, then instead of four kinds of function type, we’d only have three:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">Int</span>) -&gt; <span class="type">Int</span>               <span class="comment">// Normal function</span></span><br><span class="line">(<span class="type">Int</span>) <span class="keyword">throws</span> -&gt; <span class="type">Int</span>        <span class="comment">// Throwing function</span></span><br><span class="line">(<span class="type">Int</span>) async -&gt; <span class="type">Int</span>         <span class="comment">// Asynchronous function, can also throw</span></span><br></pre></td></tr></table></figure>
<p>The <code>try</code> marker could also be dropped from <code>try await</code>, because all <code>await</code>s would be known to throw.  For user code, you would never need the ugly <code>async throws</code> modifier stack.</p>
<p>A downside to doing this is that Cocoa in practice does have a number of completion handler APIs that do not take error arguments, and not having the ability to express that would make the importer potentially lose type information. Many of these APIs express failure in more limited ways, such as passing <code>nil</code> into the completion closure, passing in a <code>BOOL</code> to indicate success, or communicating status via side properties of the coordinating object; auditing for and recognizing all of these idioms would complicate the importer and slow the SDK modernization process. Even then, Swift subclassers overriding the <code>async</code> forms of these APIs would be allowed by the language to throw errors even though the error cannot really be communicated across the underlying Objective-C interface.</p>
<h4 id="Make-async-default-to-throws"><a href="#Make-async-default-to-throws" class="headerlink" title="Make async default to throws"></a>Make <code>async</code> default to <code>throws</code></h4><p>The other way to factor the complexity is to make it so that <code>async</code> functions default to <code>throw</code>ing, but still allow non-<code>throw</code>ing <code>async</code> functions to be expressed with <code>nonthrowing</code> (or some other spelling).  This provides this model:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">Int</span>) -&gt; <span class="type">Int</span>                     <span class="comment">// Normal function</span></span><br><span class="line">(<span class="type">Int</span>) <span class="keyword">throws</span> -&gt; <span class="type">Int</span>              <span class="comment">// Throwing function</span></span><br><span class="line">(<span class="type">Int</span>) async -&gt; <span class="type">Int</span>               <span class="comment">// Asynchronous function, can also throw.</span></span><br><span class="line">(<span class="type">Int</span>) async(nonthrowing) -&gt; <span class="type">Int</span>  <span class="comment">// Asynchronous function, doesn't throw.</span></span><br></pre></td></tr></table></figure>
<p>This model provides a ton of advantages: it is arguably the right defaults for the vast majority of clients (reducing boilerplate and syntactic noise), provides the ability for the importer and experts to get what they want.  The only downside of is that it is a less obvious design than presenting two orthogonal axes, but in the opinion of the proposal authors, this is probably the right set of tradeoffs.</p>
<h4 id="Behavior-of-beginAsync-and-suspendAsync-operations"><a href="#Behavior-of-beginAsync-and-suspendAsync-operations" class="headerlink" title="Behavior of beginAsync and suspendAsync operations"></a>Behavior of <code>beginAsync</code> and <code>suspendAsync</code> operations</h4><p>For async code to be able to interact with synchronous code, we need at least two primitive operations: one to enter a suspendable context, and another to suspend the current context and yield control back to the outer context. Aside from the obvious naming bikeshed, there are some other design details to consider. As proposed, <code>beginAsync</code> and continuation closures return <code>Void</code> to the calling context, but it may be desirable instead to have them return a value indicating whether the return was because of suspension or completion of the async task, e.g.:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Begin execution of `body`. Return `true` if it completes, or `false` if it</span></span><br><span class="line"><span class="comment">/// suspends.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">beginAsync</span><span class="params">(<span class="number">_</span> body: <span class="params">()</span></span></span> async -&gt; ()) -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="comment">/// Suspend execution of the current coroutine, passing the current continuation/// into `body` and then returning `false` to the controlling context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">suspendAsync</span>&lt;T&gt;<span class="params">(<span class="number">_</span> body: <span class="params">(<span class="number">_</span> resume: <span class="params">(T)</span></span></span></span> -&gt; <span class="type">Bool</span>) -&gt; <span class="type">Void</span>) async -&gt; <span class="type">T</span></span><br></pre></td></tr></table></figure>
<p>Instead of representing the continuation as a plain function value passed into the <code>suspendAsync</code> primitive, a specialized <code>Continuation&lt;T&gt;</code> type could be devised. Continuations are one-shot, and a nominal continuation type could statically enforce this by being a move-only type consumed by the resume operation. The continuation could also be returned by <code>beginAsync</code> or resuming a continuation instead of being passed into <code>suspendAsync</code>, which would put the responsibility for scheduling the continuation into the code that starts the coroutine instead of in the code that causes the suspension. There are tradeoffs to either approach.</p>
<h2 id="Alternatives-Considered"><a href="#Alternatives-Considered" class="headerlink" title="Alternatives Considered"></a>Alternatives Considered</h2><h4 id="Include-Future-or-other-coordination-abstractions-in-this-proposal"><a href="#Include-Future-or-other-coordination-abstractions-in-this-proposal" class="headerlink" title="Include Future or other coordination abstractions in this proposal"></a>Include <code>Future</code> or other coordination abstractions in this proposal</h4><p>This proposal does not formally propose a <code>Future</code> type, or any other coordination abstractions. There are many rational designs for futures, and a lot of experience working with them. On the other hand, there are also completely different coordination primitives that can be used with this coroutine design, and incorporating them into this proposal only makes it larger.</p>
<p>Furthermore, the shape and functionality of a future may also be affected by Swift’s planned evolution. A <code>Future</code> type designed for Swift today would need to be a <code>class</code>, and therefore need to guard against potentially multithreaded access, races to fulfill or attempts to fulfill multiple times, and potentially unbounded queueing of awaiting coroutines on the shared future; however, the introduction of ownership and move-only types would allow us to express futures as a more efficient move-only type requiring exclusive ownership to be forwarded from the fulfilling task to the receiving task, avoiding the threading and queueing problems of a class-based approach, as seen in Rust’s <span class="exturl" data-url="aHR0cHM6Ly90b2tpby5ycw==" title="https://tokio.rs">tokio.rs<i class="fa fa-external-link"></i></span> framework. tokio.rs and the C++ coroutine TR also both take the approach of making futures/continuations into templated/generic traits instead of a single concrete implementation, so that the compiler can deeply specialize and optimize state machines for composed async operations. tokio.rs and the C++ coroutine TR also both take the approach of making futures/continuations into templated/generic traits instead of a single concrete implementation, so that the compiler can deeply specialize and optimize state machines for composed async operations. Whether that is a good design for Swift as well needs further exploration.</p>
<h4 id="Have-async-calls-always-return-a-Future"><a href="#Have-async-calls-always-return-a-Future" class="headerlink" title="Have async calls always return a Future"></a>Have async calls always return a <code>Future</code></h4><p>The most commonly cited alternative design is to follow the model of (e.g.) C#, where calls to async functions return a future (aka <code>Task</code> in C#), instead of futures being a library feature separable from the core language.  Going this direction adds async/await to the language instead of adding a more general coroutine feature.</p>
<p>Despite this model being widely know, we believe that the proposed design is<br> superior for a number of reasons:</p>
<ul>
<li>Coroutines are generally useful language features beyond the domain of async/await.  For example, building async/await into the compiler would require building generators in as well.</li>
<li>The proposed design eliminates the problem of calling an API (without knowing it is async) and getting a <code>Future&lt;T&gt;</code> back instead of the expected <code>T</code> result type.  C# addresses this by suggesting that all <code>async</code> methods have their name be suffixed with <code>Async</code>, which is suboptimal.</li>
<li>By encoding <code>async</code> as a first-class part of function types, closure literals can also be transparently <code>async</code> by contextual type inference. In the future, mechanisms like <code>rethrows</code> can be extended to allow polymorphism over asynchrony for higher-level operations like <code>map</code> to work as expected without creating intermediate collections of <code>Future&lt;T&gt;</code>, although this proposal does not propose any such abstraction mechanisms in the short term.</li>
<li>The C# model for await is a unary prefix keyword, which does not compose well in the face of chaining.  Wherein C# you may have to write something like <code>x = await (await foo()).bar()</code>, with the proposed design you can simply write <code>x = await foo().bar()</code> for the same reasons that you don’t have to write <code>try</code> on every single call in a chain that can throw.</li>
<li>It is useful to be able to design and discuss futures as an independent standard library feature without tying the entire success or failure of coroutines as a language proposal to <code>Future</code>‘s existence.</li>
<li>There are multiple different interesting abstractions besides futures to consider.  By putting the details of them in the standard library, other people can define and use their own abstractions where it makes sense.</li>
<li>Requiring a future object to be instantiated at every <code>await</code> point adds overhead. Since a major use case for this feature is to adapt existing Cocoa APIs, which already use callbacks, queues, target-action, or other mechanisms to coordinate the scheduling of the continuation of an async task, introducing a future into the mix would be an additional unnecessary middleman incurring overhead when wrapping these APIs, when in most cases there is already a direct consumer for the continuation point.</li>
<li>A design that directly surfaces a monadic type like <code>Future</code> as the result of an async computation heavily implies a compiler-driven coroutine transform, whereas this design is more implementation-agnostic. Compiler-transformed coroutines are a great compromise for integrating lightweight tasks into an existing runtime model that’s already heavily callstack-dependent, or one aims to maintain efficient interop with C or other languages that heavily constrain the implementation model, and Swift definitely has both. It is conceivable that, in the eventual future, a platform such as Swift-on-the-server could provide a pure- or predominantly-Swift ABI where enough code is pure Swift to make cheap relocatable stacks the norm and overhead on C interop acceptable, as has happened with the Go runtime. This could make <code>async</code> a no-op at runtime, and perhaps allow us to consider eliminating the annotation altogether. The semantic presence of a future object between every layer of an async process would be an obstacle to the long-term efficiency of such a platform.</li>
</ul>
<p>The primary argument for adding async/await (and then generators) to the language as first-class language features is that they are the vastly most common use-case of coroutines.  In the author’s opinion, the design as proposed gives something that works better than the C# model in practice, while also providing a more useful/general language model.</p>
<h4 id="Have-a-generalized-“do-notation”-for-monadic-types"><a href="#Have-a-generalized-“do-notation”-for-monadic-types" class="headerlink" title="Have a generalized “do notation” for monadic types"></a>Have a generalized “do notation” for monadic types</h4><p>Another approach to avoiding the one-true-future-type problem of C# could be to have a general language feature for chaining continuations through a monadic interface. Although this provides a more general language feature, it still has many of the shortcomings discussed above; it would still perform only a shallow transform of the current function body and introduce a temporary value at every point the coroutine is “awaited”. Monads also compose poorly with each other, and require additional lifting and transformation logic to plumb through higher-order operations, which were some of the reasons we also chose not to base Swift’s error handling model on sugar over <code>Result</code> types. Note that the delimited continuation primitives offered in this proposal are general purpose and can in fact be used to represent monadic unwrapping operations for types like <code>Optional</code> or <code>Result</code>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doOptional</span>&lt;T&gt;<span class="params">(<span class="number">_</span> body: <span class="params">(<span class="number">_</span> unwrap: <span class="params">(T?)</span></span></span></span> async -&gt; <span class="type">T</span>) async -&gt; <span class="type">T?</span>) -&gt; <span class="type">T?</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> result: <span class="type">T?</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">unwrap</span><span class="params">(<span class="number">_</span> value: T?)</span></span> async -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> value = value &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    suspendAsync &#123; <span class="number">_</span> <span class="keyword">in</span> result = <span class="literal">nil</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  beginAsync &#123;</span><br><span class="line">    body(unwrap)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Monads that represent repeated or nondeterministic operations would not be representable this way due to the one-shot constraint on continuations, but representing such computations as straight-line code in an imperative language with shared mutable state seems like a recipe for disaster to us.</p>
<h2 id="Potential-Future-Directions"><a href="#Potential-Future-Directions" class="headerlink" title="Potential Future Directions"></a>Potential Future Directions</h2><p>This proposal has been kept intentionally minimal, but there are many possible ways to expand this in the future.  For example:</p>
<h4 id="New-Foundation-GCD-and-Server-APIs"><a href="#New-Foundation-GCD-and-Server-APIs" class="headerlink" title="New Foundation, GCD, and Server APIs"></a>New Foundation, GCD, and Server APIs</h4><p>Given the availability of convenient asynchrony in Swift, it would make sense to introduce new APIs to take advantage of it.  Filesystem APIs are one example that would be great to see.  The Swift on Server working group would also widely adopt these features. GCD could also provide new helpers for allowing <code>() async -&gt; Void</code> coroutines to be enqueued, or for allowing a running coroutine to move its execution onto a different queue.</p>
<h4 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h4><p>As part of this introduction it makes sense to extend the Swift API design guidelines and other documentation to describe and encourage best practices in asynchronous API design.</p>
<h4 id="rethrows-could-be-generalized-to-support-potentially-async-operations"><a href="#rethrows-could-be-generalized-to-support-potentially-async-operations" class="headerlink" title="rethrows could be generalized to support potentially async operations"></a><code>rethrows</code> could be generalized to support potentially <code>async</code> operations</h4><p>The <code>rethrows</code> modifier exists in Swift to allow limited abstraction over function types by higher order functions.  It would be possible to define a similar mechanism to allow abstraction over <code>async</code> operations as well. More generally, by modeling both <code>throws</code> and <code>async</code> as effects on function types, we can eventually provide common abstraction tools to abstract over both effects in protocols and generic code, simultaneously addressing the “can’t have a Sequence that <code>throws</code>“ and “can’t have a Sequence that’s <code>async</code>“ kinds of limitations in the language today.</p>
<h4 id="Blocking-calls"><a href="#Blocking-calls" class="headerlink" title="Blocking calls"></a>Blocking calls</h4><p>Affordances could be added to better call blocking APIs from <code>async</code> functions and to hard wait for an <code>async</code> function to complete.  There are significant tradeoffs and wide open design space to explore here, and none of it is necessary for the base proposal.</p>
<h4 id="Fix-queue-hopping-Objective-C-completion-handlers"><a href="#Fix-queue-hopping-Objective-C-completion-handlers" class="headerlink" title="Fix queue-hopping Objective-C completion handlers"></a>Fix queue-hopping Objective-C completion handlers</h4><p>One unfortunate reality of the existing Cocoa stack is that many asynchronous methods are<br>unclear about which queue they run the completion handler on.  In fact, one of the top hits<br>for implementing completion handlers on Stack Overflow includes this Objective-C code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (void)asynchronousTaskWithCompletion:(void (^)(void))completion;</span><br><span class="line">&#123;</span><br><span class="line">  dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Some long running task you want on another thread</span><br><span class="line"></span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      if (completion) &#123;</span><br><span class="line">        completion();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that it runs the completion handler on the main queue, not on the queue which it was<br>invoked on.  This disparity causes numerous problems for Cocoa programmers, who would<br>probably defensively write the <code>@IBAction</code> above like this (or else face a possible race<br>condition):</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">buttonDidClick</span><span class="params">(sender:AnyObject)</span></span> &#123;</span><br><span class="line">  beginAsync &#123;</span><br><span class="line">    <span class="keyword">let</span> image = await processImageData()</span><br><span class="line">    <span class="comment">// Do the update on the main thread/queue since it owns imageView.</span></span><br><span class="line">    mainQ.async &#123;</span><br><span class="line">      imageView.image = image</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This can be fixed in the Objective-C importer, which is going to be making thunks for the<br>completion-handler functions anyway: the thunk could check to see if the completion handler<br>is being run on a different queue than the function was invoked on, and if so, enqueue the<br>completion handler on the original queue.</p>
<h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p>Thanks to @oleganza for the original draft which influenced this!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/22/03/2020/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/22/03/2020/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/" class="post-title-link" itemprop="url">An Innovative Approach to Re-Design Mobile Learning Experience with X5Learn</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>
              

              <time title="created: 22-03-2020 04:06:06 / modified: 04:12:55" itemprop="dateCreated datePublished" datetime="2020-03-22T04:06:06+00:00">22-03-2020</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Patrick Wu, Yinrui Hu</p>
<h2 id="About-Us"><a href="#About-Us" class="headerlink" title="About Us"></a>About Us</h2><p><img src="/images/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/team.png" alt="teammate"></p>
<p>Hello, we are Team 4. My name is <span class="exturl" data-url="aHR0cHM6Ly93d3cubGlua2VkaW4uY29tL2luL3BhdHJpY2stZGFpcWktd3Uv" title="https://www.linkedin.com/in/patrick-daiqi-wu/">Patrick Wu<i class="fa fa-external-link"></i></span>, the team lead and a 2nd-Year Computer Science student at University College London. My interest mainly lies in low-level system design and networked systems. For this summer, I’m going to intern at a trading firm working on its infrastructural components.<br>My teammate <span class="exturl" data-url="aHR0cHM6Ly93d3cubGlua2VkaW4uY29tL2luL3lpbnJ1aS1odS0wNTAyMTUxODIv" title="https://www.linkedin.com/in/yinrui-hu-050215182/">Yinrui(Felix) Hu<i class="fa fa-external-link"></i></span>, is also a second-year computer science student studying at UCL. He is mostly interested in artificial intelligence and cyber-security related fields.<br>I am delighted to be working with Yinrui this year, and developed a brand new mobile application with many innovative approaches for UCL’s X5Learn research team, our industrial partner.</p>
<h2 id="What-have-we-been-working-on"><a href="#What-have-we-been-working-on" class="headerlink" title="What have we been working on?"></a>What have we been working on?</h2><p>Online Education is no stranger to us, students, nowadays, as we have been utilising this extensively in day to day life. For instance, due to the recent COVID-19 outbreak, UCL students would all logon to Moodle to conduct remote learning through contents of formats including but not limited to videos, texts and audios. Apart from Moodle, there are such a great number of alternatives out there, e.g. Coursera, Khan Academy, LinkedIn Learning, MIT Open Courseware and many more. The trouble mainly lies which platform to choose instead of a lack of learning materials. As a student, we have spent way too long looking for a useful resource rather than learning itself. Therefore, X5GON and X5Learn as a Software-as-a-Service (SaaS), can solve this problem for you.</p>
<p>The main focus of X5GON development team is creating a solution that will help users/students find what they need not just in OER repositories, but across all open educational resources on the web. This solution will adapt to the user’s needs and learn how to make ongoing customised recommendations and suggestions through a truly interactive and impactful learning experience.</p>
<p><img src="/images/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/desktop.png" alt="website version of X5Learn"></p>
<p>Figure 1. A demonstration of X5Learn’s website version.</p>
<p>Our goal, as a student team, is to develop a mobile application that utilises the X5Learn platform and provide an authentic and mobile-friendly user experience. With this mobile application, the X5Learn system would be able to attract more customers from the mobile platform and enable users to access their customised X5Learn learning contents at all times.</p>
<h2 id="What-are-the-technical-challenges"><a href="#What-are-the-technical-challenges" class="headerlink" title="What are the technical challenges?"></a>What are the technical challenges?</h2><p>The critical challenge above all is to differentiate our application from other proprietary learning platforms. We continuously ask ourselves how to make the app more accessible and easy to navigate around for users. Given the fact there are many established applications out there, our team considered trying them out ourselves and conduct double-blind experiments on UI, app responsiveness and content relevancy experiments. We have learnt a lot in the process and greatly influenced our design of X5GON-Mobile afterwards.</p>
<p>Whilst we are testing out multiple applications under the <code>eduroam</code> network environment, there was one significant issue that emerged out of the dark. Some apps, under mediocre network environment, suffered from constant loss of network connection and plodding loading speed. Also, given the fact that the X5Learn usually takes 10 to 15 seconds to process videos and generate analytic reports, these together makes the app increasingly laggy and unusable at all under such circumstances. This issue of performance we noticed at an early stage influenced our application design and development process thereafter and is proven to be a significant differentiating factor for our application.</p>
<p>Last but not least, another essential technical challenge we faced was that the X5Learn was in ongoing development. Hence, many of the functionalities we aim to accomplish in our project are still in development or doesn’t exist as an API from the back-end. This caused us considerable trouble initially. However, we were able to overcome this difficulty eventually and made our application more adaptable to this type of situation, which would be beneficial for future expansion of the whole platform after our delivery of the project.</p>
<h2 id="How-did-we-solve-them"><a href="#How-did-we-solve-them" class="headerlink" title="How did we solve them?"></a>How did we solve them?</h2><p><img src="/images/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/technologies.png" alt="technologies at glance"></p>
<p>Figure 2. An overview of the technologies used in this project.</p>
<p>We tackled challenges above using advanced technology provided by <code>Apple</code>, the open-source community and algorithms written by ourselves.</p>
<p><img src="/images/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/comparison.png" alt="comparison of app"></p>
<p>Figure 3. A comparison between traditional learning app and our approach.</p>
<p>From a design perspective, we took the information-feed approach rather than listing all courses available for the users find. As on most other platforms, users would have to search for what they want to learn, we actively push this information to the screen for users to choose from, similar to video sites but unlike a learning platform. Our design also utilises an innovative way of enabling users to read bullet-points or browse external supportive contents. Users can scroll to a sidebar whilst not stopping the video and start from there. They can also minimise the video to let it play as a floating window at the bottom of the screen. This design received great feedback from our clients and users at our testing stage.</p>
<p><img src="/images/An-innovative-approach-to-re-design-mobile-learning-experience-with-X5Learn/performance.gif" alt="fast fetching optimisation"></p>
<p>Figure 4. A demonstration of our app’s performance on videos.</p>
<p>With regards to the performance of the application, we utilised extensive caching and predicting techniques to minimise the lag and increase the responsiveness. First of all, the choice of using <code>Swift</code> to develop a native <code>iOS</code> application provides us with a faster foundation compared to hybrid frameworks like <code>React Native</code>. More so, our aggressive pre-loading daemon utilised a <code>HashMap</code> storing technique and regularly fetches first 20-seconds of content whenever user finds the thumbnail on display. Although we did make a trade-off of having more background tasks, which is negligible, app users now receive a notably faster application and smoother learning experience.</p>
<p>As a project that has both the ongoing development of front-end and back-end at the same time, we found it challenging to adapt to the constant changing API as an external mobile application. Therefore, we then utilised <code>SwiftSoup</code>, an external parser for HTML,<br>together with our own algorithm to analyse changing API endpoints on the fly and self-adapt the code. This still at an early stage and would require a constant change of code to actually make the new version work. However, this adaptive API layer has undoubtedly saved us a lot of time investigating broken APIs and migrating to new ones.</p>
<h2 id="Some-Final-Thoughts"><a href="#Some-Final-Thoughts" class="headerlink" title="Some Final Thoughts"></a>Some Final Thoughts</h2><p>Having never developed an <code>iOS</code> application, we have learned a lot about <code>Apple</code> ‘s tool-chain and especially the <code>Swift</code> language. While developing this project, an issue among which also encouraged to make an actual contribution to the <code>apple/swift</code> language on its co-routine implementation. Our team find this year of cooperating with UCL’s X5Learn Team very enjoyable and worthwhile.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/12/03/2020/Continuous-Probability-Distributions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/12/03/2020/Continuous-Probability-Distributions/" class="post-title-link" itemprop="url">Continuous Probability Distributions</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 12-03-2020 23:05:22" itemprop="dateCreated datePublished" datetime="2020-03-12T23:05:22+00:00">12-03-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 14-03-2020 22:20:24" itemprop="dateModified" datetime="2020-03-14T22:20:24+00:00">14-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Aside from the aforementioned Uniform Distribution, there are many types of distributions for continuous random variables.</p>
<h1 id="The-Exponential-Distribution"><a href="#The-Exponential-Distribution" class="headerlink" title="The Exponential Distribution"></a>The Exponential Distribution</h1><p>Parameter $ \lambda \quad (\lambda &gt; 0) $</p>
<script type="math/tex; mode=display">X \sim Exp(\lambda)</script><script type="math/tex; mode=display">c.d.f \quad F(x) = 1 - e^{-\lambda x} \quad (x > 0)</script><script type="math/tex; mode=display">p.d.f \quad f(x) = \frac{d F(x)}{dx} = -e^{-\lambda x} \cdot -\lambda = \lambda e^{-\lambda x} \quad (x > 0)</script><script type="math/tex; mode=display">\mu = \int_{0}^{\infty} xf(x)dx = \lambda \int_{0}^{\infty} xe^{-\lambda x}dx</script><script type="math/tex; mode=display">u = x, \quad v = \frac{e^{-\lambda x}}{-\lambda}</script><script type="math/tex; mode=display">\int xe^{-\lambda x}dx = uv - \int u'v = \frac{xe^{-\lambda x}}{-\lambda} - \frac{-1}{\lambda} \int e^{-\lambda x} dx</script><script type="math/tex; mode=display">w = -\lambda x, \quad \frac{dw}{dx} = -\lambda, \quad dx = \frac{dw}{-\lambda}</script><script type="math/tex; mode=display">\int e^{-\lambda x}dx = \int e^{w} \cdot \frac{dw}{-\lambda} = \frac{1}{-\lambda} e^{w} = \frac{1}{-\lambda} e^{-\lambda x}</script><script type="math/tex; mode=display">\int xe^{-\lambda x}dx = \frac{xe^{-\lambda x}}{-\lambda} - \frac{-1}{\lambda} \frac{1}{-\lambda} e^{-\lambda x} = -\frac{xe^{-\lambda x}}{\lambda} - \frac{e^{-\lambda x}}{\lambda^2}</script><script type="math/tex; mode=display">\mu = \lambda [-\frac{xe^{-\lambda x}}{\lambda} - \frac{e^{-\lambda x}}{\lambda^2}]_0^\infty = \lambda (0 + \frac{1}{\lambda^2}) = \frac{1}{\lambda}</script><script type="math/tex; mode=display">\sigma^2 = \int_{0}^{\infty} x^2f(x) dx - \mu^2 = \lambda \int_{0}^{\infty} x^2 e^{-\lambda x} dx - \frac{1}{\lambda^2}</script><script type="math/tex; mode=display">u = x^2, \quad v = \frac{e^{-\lambda x}}{-\lambda}</script><script type="math/tex; mode=display">\int x^2 e^{-\lambda x} dx = uv - \int u'v = \frac{x^2 e^{-\lambda x}}{-\lambda} - 2\int x \cdot \frac{e^{-\lambda x}}{-\lambda}dx = \frac{-x^2 e^{-\lambda x}}{\lambda} + \frac{2}{\lambda} \int x \cdot e^{-\lambda x}dx</script><script type="math/tex; mode=display">\int x^2 e^{-\lambda x} dx = \frac{-x^2 e^{-\lambda x}}{\lambda} + \frac{2}{\lambda} ( -\frac{xe^{-\lambda x}}{\lambda} - \frac{e^{-\lambda x}}{\lambda^2}) = \frac{-x^2 \cdot e^{-\lambda x}}{\lambda} - \frac{2xe^{-\lambda x}}{\lambda^2} -\frac{2 e^{-\lambda x}}{\lambda^3}</script><script type="math/tex; mode=display">\sigma^2 = \lambda [\frac{-x^2 \cdot e^{-\lambda x}}{\lambda} - \frac{2xe^{-\lambda x}}{\lambda^2} -\frac{2 e^{-\lambda x}}{\lambda^3}]^{\infty}_{0} - \frac{1}{\lambda^2} = \lambda (0 + \frac{2}{\lambda^3}) - \frac{1}{\lambda^2} = \frac{1}{\lambda^2}</script><h1 id="The-Normal-Distribution"><a href="#The-Normal-Distribution" class="headerlink" title="The Normal Distribution"></a>The Normal Distribution</h1><p>Parameter $ \mu, \sigma^2 $</p>
<script type="math/tex; mode=display">X \sim N(\mu, \sigma^2)</script><script type="math/tex; mode=display">p.d.f \quad f(x) = \frac{1}{\sigma \sqrt{2 \pi}} e^{-\frac{(x - \mu)^2}{2 \sigma^2}}, \quad (-\infty < x < \infty)</script><script type="math/tex; mode=display">c.d.f \quad F(x) = \int_{-\infty}^{x} f(x)dx = \int_{-\infty}^{x} \frac{1}{\sigma \sqrt{2 \pi}} e^{-\frac{(x - \mu)^2}{2 \sigma^2}} dx = \frac{1}{\sigma \sqrt{2 \pi}} \int_{-\infty}^{x} e^{\frac{- x^2 + 2\mu x - \mu^2}{2 \sigma^2}}</script><script type="math/tex; mode=display">F(x) = \frac{1}{\sigma \sqrt{2 \pi}} \cdot \int_{-\infty}^{x} e^{-\frac{1}{2\sigma^2} x^2} \cdot \int_{-\infty}^{x} e^{\frac{\mu}{\sigma^2} x} \cdot e^{\frac{-\mu^2}{2\sigma^2}} = \frac{1}{\sigma \sqrt{2 \pi}} \cdot \frac{\sqrt{\pi}\sigma \cdot erf(\frac{x}{\sqrt{2}\sigma})}{\sqrt{2}}  \cdot \frac{\sigma^2 e^{\frac{\mu x}{\sigma^2}}}{\mu} \cdot e^{\frac{-\mu^2}{2 \sigma^2}}</script><script type="math/tex; mode=display">F(x) = \frac{\sigma^2 \cdot erf(\frac{x}{\sqrt{2}\sigma}) \cdot e^{\frac{2\mu x - \mu^2}{2\sigma^2}}}{2\mu}</script><script type="math/tex; mode=display">E(X) = \mu</script><script type="math/tex; mode=display">Var(X) = \sigma^2</script><h2 id="Central-Limit-Theorem"><a href="#Central-Limit-Theorem" class="headerlink" title="Central Limit Theorem"></a>Central Limit Theorem</h2><p>The sample mean of a large independent random sample (from any distribution) is approximately normally distributed.</p>
<script type="math/tex; mode=display">\bar{X} = \frac{1}{n} \Sigma_{i = 1}^{n} X_i</script><p>$ \bar{X} $ is for large $n$, normal distributed with mean $\mu$ and variance $\frac{\sigma^2}{n}$.</p>
<script type="math/tex; mode=display">\Sigma_{i = 1}^{n} X_i \sim N(n\mu, n\sigma^2)</script><h2 id="Standard-Normal-Distribution"><a href="#Standard-Normal-Distribution" class="headerlink" title="Standard Normal Distribution"></a>Standard Normal Distribution</h2><p>Let $ X \sim N(\mu, \sigma^2) $ and let $ Z = \frac{X - \mu}{\sigma} $</p>
<script type="math/tex; mode=display">E(Z) = \frac{1}{\sigma}E(X) - \frac{\mu}{\sigma} = 0</script><script type="math/tex; mode=display">Var(Z) = \frac{1}{\sigma^2}Var(X) + 0 = 1</script><p>$ Z \sim N(0, 1) $ is standard normal distribution.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/10/03/2020/CC-Series-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/10/03/2020/CC-Series-1/" class="post-title-link" itemprop="url">C++ Notes Series (No. 1) Package Principles and Namespaces</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 10-03-2020 22:10:42" itemprop="dateCreated datePublished" datetime="2020-03-10T22:10:42+00:00">10-03-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:08:45" itemprop="dateModified" datetime="2020-03-12T02:08:45+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><blockquote>
<p>In computer programming, package principles are a way of organizing classes in larger systems to make them more organized and manageable. They aid in understanding which classes should go into which packages (package cohesion) and how these packages should relate with one another (package coupling). Package principles also includes software package metrics, which help to quantify the dependency structure, giving different and/or more precise insights into the overall structure of classes and packages. </p>
</blockquote>
<p>An important counterpart of which is <code>namespace</code> in <code>C++</code>. CPPReference states that </p>
<blockquote>
<p>Namespaces provide a method for preventing name conflicts in large projects.</p>
<p>Symbols declared inside a namespace block are placed in a named scope that prevents them from being mistaken for identically-named symbols in other scopes.</p>
<p>Multiple namespace blocks with the same name are allowed. All declarations within those blocks are declared in the named scope.</p>
</blockquote>
<h1 id="Discussion-on-functions-in-namespaces-or-classes"><a href="#Discussion-on-functions-in-namespaces-or-classes" class="headerlink" title="Discussion on functions in namespaces or classes"></a>Discussion on functions in namespaces or classes</h1><p>Putting an isolate function in a <code>namespace</code> could be rather a better decision than incorporating it in a <code>class</code> as a <code>method</code>, contradicting to what we have learnt from <code>COMP0004</code>. More specifically, whenever you can implement some functionality efficiently without having to access any private or protected code or data members, you should break it into a free function in the class’s namespace instead of leaving it as a member function. The reason is that by doing so, you keep the class’s interface as small as possible, and thereby reduce the amount of code that potentially needs to be changed if you change the private internals of the class, which is the point of Objective Oriented Programming (OOP) in the first place. Scott Meyers, author of Effective C++, <span class="exturl" data-url="aHR0cHM6Ly93d3cuZHJkb2Jicy5jb20vY3BwL2hvdy1ub24tbWVtYmVyLWZ1bmN0aW9ucy1pbXByb3ZlLWVuY2Fwc3UvMTg0NDAxMTk3" title="https://www.drdobbs.com/cpp/how-non-member-functions-improve-encapsu/184401197">goes into more detail here<i class="fa fa-external-link"></i></span>.</p>
<p>Unfortunately, separating out code that works on <code>T</code> from the class <code>T</code> itself just feels untidy to many programmers raised on the OOP mantra of “Bring code and data together”. But “bringing code and data together” doesn’t actually achieve anything material from a code maintenance or expressiveness point of view — all it gets you is a certain aesthetic appeal, so if you can get past that, you will benefit from the materially better design that comes from keeping class interfaces as small as possible.</p>
<p>If it takes a while to convince yourself that separate functions are actually the Right Thing, don’t feel bad — Meyers’s own first edition of Effective C++ made the same mistake. An example of the C++ Standard Library getting it wrong would be a function like <code>find_first_of()</code> in <code>std::string</code>, which can be implemented with full efficiency without having to know any of the internal details of a <code>std::string</code> — all such a function needs is access to the public functions <code>size()</code> and <code>operator[]()</code>.</p>
<p>To end with Scott Meyers own paragraph, </p>
<blockquote>
<p>It’s time to abandon the traditional, but inaccurate, ideas of what it means to be object-oriented. Are you a true encapsulation believer? If so, I know you’ll embrace non-friend non-member functions with the fervor they deserve.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/25/02/2020/Continuous-Random-Variables-vs-Discrete-Random-Variables-Part-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/25/02/2020/Continuous-Random-Variables-vs-Discrete-Random-Variables-Part-2/" class="post-title-link" itemprop="url">Continuous Random Variables VS. Discrete Random Variables (Part 2)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 25-02-2020 15:41:59" itemprop="dateCreated datePublished" datetime="2020-02-25T15:41:59+00:00">25-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:09:02" itemprop="dateModified" datetime="2020-03-12T02:09:02+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Continuous-Distributions"><a href="#Continuous-Distributions" class="headerlink" title="Continuous Distributions"></a>Continuous Distributions</h1><h2 id="Uniform-Distribution"><a href="#Uniform-Distribution" class="headerlink" title="Uniform Distribution"></a>Uniform Distribution</h2><script type="math/tex; mode=display">X \sim U(a, b)</script><p>This indicates that all outcomes from interval $(a, b)$ are equally likely.</p>
<script type="math/tex; mode=display">f(x) = \frac{1}{b - a} \quad \forall a < x < b</script><script type="math/tex; mode=display">f(x) = 0 \quad (otherwise)</script><script type="math/tex; mode=display">F(x) = 0 \quad \forall a \leq x</script><script type="math/tex; mode=display">F(x) = \frac{x - a}{b - a} \quad \forall a < x < b</script><script type="math/tex; mode=display">F(x) = 1 \quad \forall x \leq b</script><script type="math/tex; mode=display">E(X) = \int^b_a x \frac{1}{b - a}dx =  [\frac{x^2}{2(b - a)}]^b_a = \frac{b^2 - a^2}{2(b - a)} = \frac{a + b}{2}</script><script type="math/tex; mode=display">Var(X) = \int^b_a x^2 \frac{1}{b - a}dx - E(X)^2 = [\frac{x^3}{3(b - a)}]^b_a - E(X)^2 = \frac{b^3 - a^3}{3(b - a)} - E(X)^2</script><script type="math/tex; mode=display">= \frac{(b - a)(b^2 + ab + a^2}{3(b - a)} - E(X)^2 = \frac{b^2 + ab + a^2}{3} - \frac{a^2 + b^2 + 2ab}{4}</script><script type="math/tex; mode=display">= \frac{4b^2 + 4ab + 4a^2 - 3a^2 - 3b^2 - 6ab}{12} = \frac{a^2 - 2ab + b^2}{12} = \frac{(a - b)^2}{12}</script><ul>
<li>Possible Usage: as a starting point in simulations, if we can generate a random number in $U(0, 1)$, we can arbitrarily expand the range to almost any other uniform distribution</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/24/02/2020/Continuous-Random-Variables-vs-Discrete-Random-Variables-Part-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/24/02/2020/Continuous-Random-Variables-vs-Discrete-Random-Variables-Part-1/" class="post-title-link" itemprop="url">Continuous Random Variables VS. Discrete Random Variables (Part 1)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 24-02-2020 20:39:55" itemprop="dateCreated datePublished" datetime="2020-02-24T20:39:55+00:00">24-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:08:55" itemprop="dateModified" datetime="2020-03-12T02:08:55+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><ul>
<li>Discrete random variable : countable number of possible values</li>
<li><p>Continuous random variable : uncountably (infinite) number of possible values</p>
</li>
<li><p>The cumulative distribution function of a variable $X$ is the function</p>
</li>
</ul>
<script type="math/tex; mode=display">F(x) = P(X \leq x) \quad \forall x \in R</script><ul>
<li>The probability density function of a variable $X$ is the function</li>
</ul>
<script type="math/tex; mode=display">f(x) = \frac{dF(x)}{dx}</script><p>A given point on $f(x)$ should <strong>not</strong> be interpreted as $f(x) = P(X = x)$. It should be an analogy to density, or change of probability rate at $x$.</p>
<p>Properties for $f(x)$,</p>
<ul>
<li><p>$f(x) \geq 0, \forall x \in R $</p>
</li>
<li><p>$\int_a^b f(x) dx = [F(x)]_a^b = F(b) - F(a) = P(a &lt; X \leq B) $</p>
</li>
<li><p>$\int_{-\infty}^{\infty}f(x) dx = P(-\infty &lt; X \leq + \infty) = 1 $</p>
</li>
</ul>
<p>Population Mean</p>
<script type="math/tex; mode=display">\mu = E(X) = \int_{-\infty}^{\infty} xf(x) dx</script><script type="math/tex; mode=display">\sigma^2 = Var(X) = E[X^2] - E[X]^2 = \int_{-\infty}^{\infty} x^2 f(x)dx - \mu^2</script><p>For any transformation made on $x$, let $g(x)$</p>
<script type="math/tex; mode=display">E(g(x)) = \int_{-\infty}^{\infty} g(x)f(x) dx</script><p>Two continuous random variables $X$ and $Y$ are independant </p>
<script type="math/tex; mode=display">\iff P(X = x_i, Y = y_j) = P(X = x_i) \cdot P(Y = y_j) \quad \forall x_i, y_j</script><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Given a unit circle marked with $0, 1, 2, 3$ at $\theta = 0, \frac{\pi}{2}, \pi, \frac{3\pi}{2}$ respectively. The circumference of the unit circle has value range from $0 \leq Y &lt; 4$.</p>
<p>A pointer from the origin with length of $1$ is spun and is equally likely to stop anywhere on the circle. Let $Y$ be the value obtained from the circle.</p>
<p>$Y$ is a continuous random variable.</p>
<script type="math/tex; mode=display">P(Y \leq 1) = \frac{1}{4}</script><script type="math/tex; mode=display">P(Y \leq 2) = \frac{1}{2}</script><script type="math/tex; mode=display">P(3 < Y \leq 3.5) = \frac{1}{8}</script><p>In the example above</p>
<script type="math/tex; mode=display">F(y) = 0 \; (y < 0), \quad F(y) = \frac{y}{4} \; (0 \leq y < 4), \quad F(y) = 1 \; (4 \leq y)</script><script type="math/tex; mode=display">f(y) = F'(y) = \frac{1}{4} \; (0 \leq y < 4)</script><script type="math/tex; mode=display">\mu = \int_{0}^{4} y \cdot \frac{1}{4} = [\frac{1}{8}y^2]_0^4 = 2</script><script type="math/tex; mode=display">\sigma^2 = \int_{0}^{4} \cdot y^2 \frac{1}{4} - 2^2= [\frac{1}{12}y^3]_0^4 - 4 = \frac{4}{3}</script><h2 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h2><p>In the next post, we will be looking at continuous distributions, as similar to discrete distributions in previous posts <a href="https://blog.patrickwu.uk/11/02/2020/Statistical-Distributions-Part-1/">here, part 1</a> and <a href="https://blog.patrickwu.uk/12/02/2020/Statistical-Distributions-Part-2/">here, part 2</a>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/23/02/2020/CC-Series-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/23/02/2020/CC-Series-0/" class="post-title-link" itemprop="url">C++ Notes Series (No. 0)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 23-02-2020 01:42:31" itemprop="dateCreated datePublished" datetime="2020-02-23T01:42:31+00:00">23-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:08:36" itemprop="dateModified" datetime="2020-03-12T02:08:36+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hi, I have decided to start a series to blog post to enrich my blog content and also, share several insights of myself when learning <code>C++</code>, especially modern <code>C++</code> features.</p>
<p>I have made a list below on possible features I am looking at to write in this series.</p>
<h1 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h1><ul>
<li>Pointers and Smart Pointers</li>
<li>Classes, Structs, Constructors, Destructors, Copy Constructors</li>
<li>More on OOP: Inheritance, Virtual Functions, Interfaces, Visibility</li>
<li>STLs</li>
<li>Macros and Lambdas</li>
<li>Namespaces</li>
<li>Threads, Concurrency features</li>
<li>Design Patterns: Singletons, Factories</li>
<li>Move semantics, Rvalue References, Forwarding References, <code>auto</code> keyword</li>
<li>Maps and Sets Splicing</li>
<li>Parallel Algorithms in <code>C++17</code></li>
</ul>
<p>This is the content list for the moment, and I believe this will keep me busy for a while. However, if there is something specific you want to see, please don’t hesitate to drop me an email at patrick.wu (at) linux.com .</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/13/02/2020/Exploring-Flask-Auth-Methods-Part-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/13/02/2020/Exploring-Flask-Auth-Methods-Part-2/" class="post-title-link" itemprop="url">Exploring Flask Authentication Methods Part 2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 13-02-2020 20:27:47" itemprop="dateCreated datePublished" datetime="2020-02-13T20:27:47+00:00">13-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:09:27" itemprop="dateModified" datetime="2020-03-12T02:09:27+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Continued"><a href="#Continued" class="headerlink" title="Continued"></a>Continued</h2><p>Last time we talked about CSRF tokens. So what is CSRF?</p>
<h3 id="Cross-Site-Request-Forgery"><a href="#Cross-Site-Request-Forgery" class="headerlink" title="Cross-Site Request Forgery"></a>Cross-Site Request Forgery</h3><p>Well, <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2Zvcmdlcnk=" title="https://en.wikipedia.org/wiki/Cross-site_request_forgery">Wikipedia<i class="fa fa-external-link"></i></span> has a brief explanation of how it works. In short,</p>
<blockquote>
<p>Cross-site request forgery, also known as one-click attack or session riding and abbreviated as CSRF (sometimes pronounced sea-surf[1]) or XSRF, is a type of malicious exploit of a website where unauthorized commands are transmitted from a user that the web application trusts.</p>
</blockquote>
<p>There are many ways to utilise CSRF on unprotected websites. However, this can be largely prevented by providing the user with a <code>csrf_token</code> only when they logging in on the valid website, and storing them in sessions.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>My final solution to this problem, in the <code>Swift</code> code below, is to use a web request to get a <code>csrf_token</code> and then login with a valid user request.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">fetchCSRFToken</span> <span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> csrfToken = <span class="string">""</span></span><br><span class="line">    <span class="keyword">let</span> semaphore = <span class="type">DispatchSemaphore</span>(value: <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">let</span> task = <span class="type">URLSession</span>.shared.dataTask(with: <span class="type">URL</span>.<span class="keyword">init</span>(string: newAdapter.generateLoginQueryURL())!) &#123;(data, response, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">defer</span> &#123; semaphore.signal() &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> divFields: <span class="type">Elements</span> = <span class="keyword">try</span> <span class="type">SwiftSoup</span>.parse(<span class="type">String</span>(decoding: data, <span class="keyword">as</span>: <span class="type">UTF8</span>.<span class="keyword">self</span>)).body()!.select(<span class="string">"div"</span>)</span><br><span class="line">            <span class="keyword">let</span> centreDiv = divFields.array()[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">let</span> inputFields = <span class="keyword">try</span> centreDiv.select(<span class="string">"form"</span>).first()!.select(<span class="string">"input"</span>)</span><br><span class="line">            <span class="keyword">for</span> inputField <span class="keyword">in</span> inputFields &#123;</span><br><span class="line">                <span class="keyword">if</span> inputField.id() == <span class="string">"csrf_token"</span> &#123;</span><br><span class="line">                    csrfToken = <span class="keyword">try</span> inputField.val()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"error: cannot fetch csrf token"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    task.resume()</span><br><span class="line">    semaphore.wait()</span><br><span class="line">    <span class="keyword">if</span> (csrfToken == <span class="string">""</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"error: cannot fetch csrf token"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> csrfToken</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Afterwards, generate a <code>POST</code> request in <code>JSON</code> style (e.g. <code>{email: &quot;x5user@mail.com&quot;, password:&quot;pwd&quot;, csrf_token:&quot;token&quot;}</code>) and post it to your designated <code>flask-security</code> login endpoint. You will get a response with your authentication token. From then on, use this authentication token for future requests.</p>
<h2 id="What’s-more"><a href="#What’s-more" class="headerlink" title="What’s more?"></a>What’s more?</h2><p>Authentication tokens should have a valid lifetime and re-authenticate from time to time to ensure better security. We have yet to come up with a solution to modify <code>flask-security</code>‘s internal mechanisms to realise this feature.</p>
<p>Regarding the <code>HTTP</code> request, we are planning to adapt to <code>Alamofire</code> for more elegant network solutions.</p>
<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>For more information, checkout</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2Zvcmdlcnk=" title="https://en.wikipedia.org/wiki/Cross-site_request_forgery">Wikipedia - Cross-site Request Forgery<i class="fa fa-external-link"></i></span> </li>
<li><span class="exturl" data-url="aHR0cHM6Ly9mbGFzay13dGYucmVhZHRoZWRvY3MuaW8vZW4vc3RhYmxlL2NzcmYuaHRtbA==" title="https://flask-wtf.readthedocs.io/en/stable/csrf.html">CSRF Protection - Flask<i class="fa fa-external-link"></i></span></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/12/02/2020/Statistical-Distributions-Part-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/12/02/2020/Statistical-Distributions-Part-2/" class="post-title-link" itemprop="url">Statistical Distributions (Part 2)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 12-02-2020 10:29:05" itemprop="dateCreated datePublished" datetime="2020-02-12T10:29:05+00:00">12-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 15-03-2020 00:14:15" itemprop="dateModified" datetime="2020-03-15T00:14:15+00:00">15-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Poisson-Distribution-Continued"><a href="#Poisson-Distribution-Continued" class="headerlink" title="Poisson Distribution (Continued)"></a>Poisson Distribution (Continued)</h1><p>As stated in the previous post, </p>
<p>Let </p>
<script type="math/tex; mode=display">\lambda = n \cdot p</script><script type="math/tex; mode=display">Binomial(n, p) \approx Poisson(n p) = Poisson(\lambda)</script><p>For Binomial Distribution,</p>
<script type="math/tex; mode=display">P(x) = C_n^x p^x q^{n-x} = C_n^x \cdot (\frac{\lambda}{n})^x \cdot (1 - \frac{\lambda}{n})^{n -x}</script><p>Thus,</p>
<script type="math/tex; mode=display">\lim_{n \rightarrow \infty} P(x) = \lim_{n \rightarrow \infty} \frac{n \cdot (n - 1) ... \cdot (n - x + 1)}{x!} \cdot \frac{\lambda^x}{n^x} \cdot (1 - \frac{\lambda}{n})^n \cdot (1 - \frac{\lambda}{n})^{-x}</script><script type="math/tex; mode=display">= \lim_{n \rightarrow \infty} \frac{n \cdot (n - 1) ... \cdot (n - x+ 1)}{n^x} \cdot \frac{\lambda^x}{x
!} \cdot \lim_{n \rightarrow \infty} (1 - \frac{\lambda}{n})^n (1 - \frac{\lambda}{n})^{-x}</script><script type="math/tex; mode=display">= 1 \cdot \frac{\lambda^x}{x!} \cdot e^{-\lambda} \cdot 1 = e^{-\lambda} \cdot \frac{\lambda^k}{k!}</script><p>The positive real number $\lambda$ is equal to the expected value and also its variance.</p>
<script type="math/tex; mode=display">\lambda = \mu = \sigma^2</script><h1 id="Gaussian-Distribution-Normal-Distribution"><a href="#Gaussian-Distribution-Normal-Distribution" class="headerlink" title="Gaussian Distribution (Normal Distribution)"></a>Gaussian Distribution (Normal Distribution)</h1><h2 id="Probability-Density-Function"><a href="#Probability-Density-Function" class="headerlink" title="Probability Density Function"></a>Probability Density Function</h2><p>Given <script type="math/tex">\mu = E(X)</script> and <script type="math/tex">\sigma^2 = Var(X)</script>,</p>
<script type="math/tex; mode=display">f(x \mid \mu, \sigma^2) = \frac{1}{\sqrt{2\pi\sigma^2}} \; e^{-\frac{(x-\mu)^2}{2\sigma^2}}</script><p>A standard normal distribution follows <script type="math/tex">\mu = 1</script> and <script type="math/tex">\sigma^2 = 1</script></p>
<h2 id="Cumulative-Distribution-Function"><a href="#Cumulative-Distribution-Function" class="headerlink" title="Cumulative Distribution Function"></a>Cumulative Distribution Function</h2><p>Cumulative Distribution Function, or <script type="math/tex">F(x)</script> is the probability that <script type="math/tex">X \leq x</script>.</p>
<script type="math/tex; mode=display">F(x \mid \mu, \sigma^2) = \frac{1}{\sqrt{2\pi \sigma^2}} \int_{-\infty}^{x} e^{-\frac{(t-\mu)^2}{2\sigma^2}}dt</script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.patrickwu.uk/11/02/2020/Statistical-Distributions-Part-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="patrick wu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/11/02/2020/Statistical-Distributions-Part-1/" class="post-title-link" itemprop="url">Statistical Distributions (Part 1)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">posted on</span>

              <time title="created: 11-02-2020 19:33:07" itemprop="dateCreated datePublished" datetime="2020-02-11T19:33:07+00:00">11-02-2020</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">edited on</span>
                <time title="modified: 12-03-2020 02:09:43" itemprop="dateModified" datetime="2020-03-12T02:09:43+00:00">12-03-2020</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Discrete-Random-Variable"><a href="#Discrete-Random-Variable" class="headerlink" title="Discrete Random Variable"></a>Discrete Random Variable</h1><p>Given <script type="math/tex">X</script>, a discrete random variable, </p>
<p>Population Mean (Expectancy) </p>
<script type="math/tex; mode=display">\mu = E(X) = \Sigma^{N}_{i = 1}x_i p_i</script><p>Population Variance </p>
<script type="math/tex; mode=display">\sigma^2 = Var(X) = E[(X - \mu)^2] = \Sigma^{N}_{i = 1}(x_i - \mu)^2p_i = \Sigma^{N}_{i = 1}x_i^2p_i - \mu^2</script><p>If two discrete random variables $X$ and $Y$ are independent, </p>
<script type="math/tex; mode=display">P(X = x, Y = y) = P(X = x)\cdot P(Y = y)</script><h1 id="Bernoulli-Distribution"><a href="#Bernoulli-Distribution" class="headerlink" title="Bernoulli Distribution"></a>Bernoulli Distribution</h1><script type="math/tex; mode=display">p = P(success)</script><p>If success, <script type="math/tex">X = 1</script>. If failure, <script type="math/tex">X = 0</script>.</p>
<script type="math/tex; mode=display">P(X = 1) = p, \quad P(X = 0) = 1 - p</script><script type="math/tex; mode=display">E(X) = p \cdot 1 + (1 - p) \cdot  0 = p</script><script type="math/tex; mode=display">Var(X) = p - p^2 = p(1 - p)</script><h1 id="Binomial-Distribution"><a href="#Binomial-Distribution" class="headerlink" title="Binomial Distribution"></a>Binomial Distribution</h1><p>$X = $ number of successes in <script type="math/tex">n</script> independent repetitions of the experiment.</p>
<p>Define <script type="math/tex">X_i</script> as the <script type="math/tex">i</script>th repetition’s success or not. <script type="math/tex">X_i</script> follows a Bernoulli Distribution.</p>
<script type="math/tex; mode=display">E(X_i) = p, \quad Var(X_i) = p(1 - p)</script><script type="math/tex; mode=display">X = \Sigma_{i = 1}^{n} X_i</script><script type="math/tex; mode=display">E(X) = n \cdot p, Var(X) = n \cdot p(1 - p)</script><script type="math/tex; mode=display">P(X = k) = C_n^k p^k (1 - p)^{n - k}</script><h1 id="Geometric-Distribution"><a href="#Geometric-Distribution" class="headerlink" title="Geometric Distribution"></a>Geometric Distribution</h1><p>$X = $ number of tries up to and including first success</p>
<script type="math/tex; mode=display">P(X = k) = (1 - p)^{k - 1}p</script><script type="math/tex; mode=display">E(X) = \Sigma_{k = 1}^{n}kp(1 - p)^{k - 1} = p(1 + 2(1 - p) + 3(1 - p)^2 + ... + n(1 - p)^{n - 1})</script><p>Let </p>
<script type="math/tex; mode=display">q = 1 - p, \quad S = 1 + 2q + 3q^2 + ... + n q^{n- 1}</script><script type="math/tex; mode=display">qS = q + 2q^2 + ... + n q^{n}</script><script type="math/tex; mode=display">(1 - q)S = 1 + q + q^2 + ... + q^{n - 1} - nq^n = \frac{1 - q^n}{1 - q} - nq^n</script><script type="math/tex; mode=display">S = \frac{1 - q^n}{(1 - q)^2} - \frac{nq^n}{1 - q}</script><p>Given <script type="math/tex">0 < q < 1, \quad n \xrightarrow{} \infty</script></p>
<script type="math/tex; mode=display">\lim_{n \xrightarrow{} \infty} S = \frac{1}{(1 - q)^2}</script><p>Such that <script type="math/tex">E(X) = \frac{p}{(1 - q)^2} = \frac{1}{p}</script></p>
<script type="math/tex; mode=display">Var(X) = E(X^2) - E(X)^2</script><p>Using the same method as above, <script type="math/tex">E(X^2) = p\frac{1 - q^2}{(1 - q)^4} = p\frac{1 + q}{(1 - q)^3} = \frac{1 + q}{(1 - q)^2}</script></p>
<script type="math/tex; mode=display">Var(X) = \frac{1 + q}{(1 - q)^2} - \frac{1}{p^2} = \frac{q}{p^2}</script><h1 id="Poisson-Distribution-To-be-continued…"><a href="#Poisson-Distribution-To-be-continued…" class="headerlink" title="Poisson Distribution (To be continued…)"></a>Poisson Distribution (To be continued…)</h1><script type="math/tex; mode=display">P(X = k) = \frac{e^{-\mu}\mu^k}{k!}, \quad E(X) = \mu, \quad Var(X) = \mu</script><p>Poisson Distribution is essentially a binomial distribution with very large $n$ (very small time interval).</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          table of contents
        </li>
        <li class="sidebar-nav-overview">
          overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">patrick wu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hZ2V0cm9u" title="github → https:&#x2F;&#x2F;github.com&#x2F;magetron"><i class="fa fa-fw fa-github"></i>github</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnBhdHJpY2sud3VAbGludXguY29t" title="email → mailto:patrick.wu@linux.com"><i class="fa fa-fw fa-envelope"></i>email</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9vbGQtYmxvZy5wYXRyaWNrd3UudWs=" title="old-blog → https:&#x2F;&#x2F;old-blog.patrickwu.uk"><i class="fa fa-fw fa-cube"></i>old-blog</span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-globe"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">patrick wu</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      script.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
